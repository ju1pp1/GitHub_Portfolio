stages: [build, test, package, smoketest, scan, deliver]

variables:
  IMAGE_NAME: "$HARBOR_URL/$HARBOR_PROJECT/pipeline-task"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  IMAGE_REF: "$IMAGE_NAME:$IMAGE_TAG"

# BUILD

build:
  stage: build
  image: maven:3.9-amazoncorretto-21
  script:
    - cd pipeline-task
    - mvn -q -DskipTests package
    - cp target/app.jar ../app.jar
  artifacts:
    when: always
    paths: [app.jar]
    expire_in: 1 week

# TEST

test:
  stage: test
  needs: ["build"]
  image: amazoncorretto:21-alpine
  before_script:
    - apk add --no-cache curl
    - chmod +x pipeline-task/src/test/api-test.sh || true
  script:
    - java -jar app.jar & echo $! > app.pid
    - pipeline-task/src/test/api-test.sh
  after_script:
    - kill $(cat app.pid) || true
  artifacts:
    when: always
    #reports:
    #  junit: []
    paths: [test-report.txt]
    expire_in: 1 week

# PACKAGE

package:
  stage: package
  image: docker:27
  services: [docker:27-dind]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "Building $IMAGE_REF"
    - ls -l app.jar Dockerfile
    - docker build -t "$IMAGE_REF" -f Dockerfile .
    - docker image save "$IMAGE_REF" -o image.tar
    - ls -lh image.tar
  artifacts:
    when: always
    paths: [image.tar]
    expire_in: 1 week
  needs: ["build"]

# SMOKETEST

smoketest:
  stage: smoketest
  image: docker:27
  services: [docker:27-dind]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker load -i image.tar
    - docker run -d --name app "$IMAGE_REF"
    - sleep 1
    - docker logs app | tail -n +1
    - |
      docker exec app sh -euc '
        apk add --no-cache curl >/dev/null 2>&1 || true
        curl -v -X POST \
          -H "Content-Type: application/json" \
          -H "Accept: text/plain" \
          -d "{\"numbers\":[1,3,7,8]}" \
          http://localhost:8199
      ' | tee smoketest-output.txt
    - docker rm -f app
  artifacts:
    when: always
    paths: [smoketest-output.txt]
    expire_in: 1 week
  needs: ["package"]

# SCAN

scan:
  stage: scan
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  #allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "deliver"'
      allow_failure: true
    - when: on_success
  script:
    - trivy image --input image.tar --exit-code 1 --severity HIGH,CRITICAL --format json -o trivy-report.json
  artifacts:
    when: always
    paths: [trivy-report.json]
    expire_in: 2 weeks
  needs: ["package"]

# DELIVER

deliver:
  stage: deliver
  image: docker:27
  services: [docker:27-dind]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  rules:
    - if: '$CI_COMMIT_BRANCH == "deliver"'
  needs:
    - job: package
    - job: scan
      optional: true
  script:
    - echo "$HARBOR_PASSWORD" | docker login "$HARBOR_URL" -u "$HARBOR_USERNAME" --password-stdin
    - docker load -i image.tar
    - docker push "$IMAGE_REF"
    - docker tag "$IMAGE_REF" "$IMAGE_NAME:latest"
    - docker push "$IMAGE_NAME:latest"